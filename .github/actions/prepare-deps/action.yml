# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Prepare dependencies'
description: 'Fetches and builds tools and dependencies'
runs:
  using: 'composite'
  steps:
    # https://github.com/actions/runner-images/issues/709
    - name: â™»ï¸ Free up disk space
      run: |
        echo "ðŸš§ Starting cleanup operations..."
        echo "ðŸ¤– Deleting Boost..."
        sudo rm -rf "/usr/local/share/boost"

        echo "ðŸ¤– Deleting Android SDKs... Beep boop, bye-bye!"
        sudo rm -rf /usr/local/lib/android

        echo "ðŸ—‘ï¸  Tossing .NET..."
        sudo rm -rf /usr/share/dotnet

        echo "ðŸ§™â€â™‚ï¸ Vanishing Haskell..."
        sudo rm -rf /opt/ghc

        echo "ðŸ” Losing CodeQL..."
        sudo rm -rf /opt/codeql

        echo "ðŸ› ï¸  Emptying the Tool Cache... (We don't need no tools!)"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"

        # Check space
        echo "ðŸš€ Space freed! Let's see how much room for activities we have:"
        df -h
      shell: bash

    - name: ðŸ”§ Install tools
      run: |
        sudo apt-get update && sudo apt-get install -y curl gpg
        curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg
        sudo mv bazel-archive-keyring.gpg /usr/share/keyrings
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/bazel-archive-keyring.gpg] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
        sudo apt-get update && sudo apt-get install -y git curl wget python3 xz-utils lsb-release pkg-config bazel-7.4.1 libicu-dev apt-transport-https gnupg
      shell: bash

    - name: ðŸ“… Set Time Zone
      run: echo "TZ=UTC" >> $GITHUB_ENV
      shell: bash

    # We want to cache the build once per day, so we include the date in the version.
    - name: ðŸ§± Generate Cache Version
      run: |
        CACHE_VERSION=${{ runner.os }}-$(date +%Y-%V-%D)-webrtc
        echo "CACHE_VERSION=$CACHE_VERSION" >> $GITHUB_ENV
      shell: bash

    # Caches are TTL'd to 7 days after last access.
    # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/caching-dependencies-to-speed-up-workflows#usage-limits-and-eviction-policy
    - name: ðŸ“¦ Cache WebRTC build
      id: cache-webrtc
      uses: actions/cache@v4
      with:
        path: webrtc-checkout
        key: ${{ env.CACHE_VERSION }}

    - name: ðŸ”¨ Install depot_tools
      if: ${{ steps.cache-webrtc.outputs.cache-hit != 'true' }}
      run: |
        git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "$(pwd)/depot_tools" >> $GITHUB_PATH
      shell: bash
